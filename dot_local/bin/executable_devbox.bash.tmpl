#!/usr/bin/env bash

## Unattended setup script for bootstrapping my dev/shell container

set -euo pipefail

dl() {
	local url=$1

	curl --proto "=https" --tlsv1.2 -sSLf "$url"
}

packages=(
	bat

	cmake
	coreutils
	cpanm

	eza

	fd-find
	fontconfig-devel
	freetype-devel
	fswatch
	fzf

	git-delta

	lazygit
	libxkbcommon-x11
	libXcursor

	openssl-devel

	neovim
	ripgrep

	xclip
	xdotool
	xsel
	xwininfo

	wezterm
)

repos=(
	atim/lazygit
	wezfurlong/wezterm-nightly
)

for repo in "${repos[@]}"; do
	sudo dnf -y copr enable "$repo"
done

sudo dnf -y install "${packages[@]}"

PATH=$HOME/.cargo/bin:$PATH
dl "https://sh.rustup.rs" | sh -s -- -q -y --no-modify-path

cargo_packages=(
	atuin
	mise
	starship
)

BINSTALL_URL="https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh"
curl --proto "=https" --tlsv1.2 -sSLf "$BINSTALL_URL" | bash

for package in "${cargo_packages[@]}"; do
	cargo binstall -y "$package"
done

mise use -g 'node@20'
mise use -g 'python@3.12'

{{ if hasSuffix "rbmpc" .chezmoi.fqdnHostname }}
cargo_git_packages=("https://github.com/neovide/neovide")

for package in "${cargo_git_packages[@]}"; do
	cargo install --git "$package" neovide
done
{{ end }}

OPT_DIR=$HOME/.local/opt
NNVIM_DIR=$OPT_DIR/nvim-nightly-bin

setup_nnvim() {
	mkdir -p "$OPT_DIR"
	NNVIM_URL="https://github.com/neovim/neovim/releases/download/nightly/nvim-linux64.tar.gz"
	dl "$NNVIM_URL" |
		tar -C "$OPT_DIR" \
			--strip-components=1 \
			--transform 's,bin/nvim$,bin/nvim-nightly,' \
			--overwrite \
			-xzf -
}

if [[ ! -x $NNVIM_DIR/bin/nvim-nightly-bin ]]; then
	setup_nnvim
fi

BLESH_URL="https://github.com/akinomyoga/ble.sh.git"

{
	git clone --recursive --depth 1 --shallow-submodules "$BLESH_URL"
	make -k -C ble.sh install PREFIX="$HOME/.local"
	rm -rf ble.sh
}

FONT_DIR=$HOME/.local/share/fonts
FIRA_CODE_URL="https://github.com/ryanoasis/nerd-fonts/releases/download/v3.2.1/FiraCode.tar.xz"
{
	mkdir -p "$FONT_DIR"
	dl "$FIRA_CODE_URL" | tar -C "$FONT_DIR" -xJf -
	fc-cache
}

EXPORT_BIN_PATH=$HOME/.local/bin

export_bins=(
	/usr/bin/bat
	/usr/bin/eza
	/usr/bin/fzf

	{{ if eq .chezmoi.hostname "rbmpc" }}
	"$HOME/.cargo/bin/neovide"
	{{ end }}

	/usr/bin/nvim
	"$OPT_DIR/bin/nvim-nightly"
)

for bin in "${export_bins[@]}"; do
	distrobox-export --export-path "$EXPORT_BIN_PATH" --bin "$bin"
done

{{ if eq .chezmoi.hostname "dev" }}
{{ if hasSuffix "rbmpc" .chezmoi.fqdnHostname }}
distrobox-export --app wezterm
{{ end }}
distrobox-export --export-path "$EXPORT_BIN_PATH" --bin /usr/bin/wezterm
{{ end }}
